class ResponseTimeBenchmark{constructor(t){t||(t=window.location.origin),"object"==typeof t&&t.length||(t=[t]),this.urls=t,this.xhr=new XMLHttpRequest,this.xhr.withCredentials=!0;var s=this;this.xhr.addEventListener("loadstart",function(t){Date.now()-this.tsSend>0&&s.logEvent(t)}),this.xhr.addEventListener("progress",function(){s.gotFirstByte||(s.gotFirstByte=!0,s.timeFirstByte=Date.now()-s.tsSend)}),this.xhr.addEventListener("abort",function(t){s.logEvent(t)}),this.xhr.addEventListener("error",function(t){s.logEvent(t),s.isRunning&&(s.doneFailed(s),s.isRunning=!1)}),this.xhr.addEventListener("load",function(){var t=Date.now()-s.tsSend;s.addTiming(t)}),this.xhr.addEventListener("timeout",function(t){s.logEvent(t)}),this.xhr.addEventListener("loadend",function(){window.setTimeout(s.doRequest.bind(s),s.requestPause)}),this.xhr.addEventListener("readystatechange",function(t){}),this.reset()}reset(){this.canceled=!1,this.curUrlIdx=-1,this.timingIdx=-1,this.maxIterations=1,this.ttfbs=new Array(this.urls.length),this.ttlbs=new Array(this.urls.length),this.lastProgress=new Array(this.urls.length),this.doneOk=function(){},this.isRunning=!1,this.headRequests=0,this.lastUrlString=""}setProgressCallback(t){this.progressCallback=t}setContentNeedle(t){this.contentNeedle=t}addCapture(t,s,e){this.captures||(this.captures={}),this.captures[t]={regex:s,scale:e||1,data:null}}addFixture(t,s){this.fixtures||(this.fixtures={}),this.fixtures[t]=s}addConstant(t,s){this.constants||(this.constants={}),this.constants[t]={r:s,v:void 0}}cancel(){this.canceled=!0;try{this.xhr.abort()}catch(t){}}doRequest(){if(this.curUrlIdx=(this.curUrlIdx+1)%this.urls.length,0===this.curUrlIdx){if(this.maxIterations>0&&this.timingIdx>=this.maxIterations||this.maxTime>0&&Date.now()>this.maxTime||this.canceled){if(console.log("benchmark stopped"),this.isRunning=!1,!this.lastProgress[0])return void(this.doneFailed&&this.doneFailed(new Error("no good captures")));for(var t=0;t<this.urls.length;t++)this.lastProgress[t].url=this.urls[t];return this.captures&&(this.lastProgress.captureNames=Object.keys(this.captures)),void(this.doneOk&&this.doneOk(this.lastProgress))}this.timingIdx++}this.lastUrlString="function"==typeof this.urls[this.curUrlIdx]?this.urls[this.curUrlIdx]():this.urls[this.curUrlIdx];var s=this.lastUrlString.replace(/[&?]+$/g,"");s+=-1!==s.indexOf("?")?"&":"?",this.xhr.open(this.headRequests?"HEAD":"GET",s+"r="+Math.random()),this.tsSend=Date.now(),this.gotFirstByte=!1,this.xhr.send(null)}run(t,s,e){if(this.isRunning)throw"benchmark is running";this.reset(),this.requestPause=e>0?e:40,this.progressCallback||console.warn("running benchmark without progress handler!");for(r=0;r<this.urls.length;r++)this.ttfbs[r]=new Uint16Array(4096),this.ttlbs[r]=new Uint16Array(4096);if(this.captures)for(var i in this.captures){this.captures[i].data=new Array(this.urls.length);for(var r=0;r<this.urls.length;r++)this.captures[i].data[r]=new Float32Array(4096)}this.isRunning=!0,this.maxIterations=t||30,this.timeStarted=Date.now(),this.maxTime=s&&this.timeStarted+s||0,this.doRequest();var n=this;return new Promise(function(t,s){n.doneOk=t,n.doneFailed=s})}logEvent(t){var s=Date.now()-this.tsSend;console.log(t.type+" after "+s+" ms")}mean(t,s,e){s<0&&(s=0);for(var i=0,r=s;r<e;r++)i+=t[r];return i/(e-s)}getMidVal(t){if(0===t.length)return 0;let s=Math.floor(t.length/2);return t.length%2?t[s]:(t[s-1]+t[s])/2}getStats(t,s){var e=this.mean(t,s-20,s),i=this.mean(t,0,s);let r=function(t,s){return t-s},n=t.slice(0,s);n.sort(r);let a=15,h=t.slice(Math.max(0,s-a),s);h.sort(r),a=3;let o=t.slice(Math.max(0,s-a),s);o.sort(r);return{cur:t[s-1],med:this.getMidVal(n),med3:this.getMidVal(o),med15:this.getMidVal(h),min:n[Math.min(n.length-1,0)],max:n[Math.max(n.length-1-0,0)],n:s,avg:i,avg20:e,std:this.standardDeviation(n),data:t.slice(0,s)}}standardDeviation(t){var s=this.average(t),e=t.map(function(t){var e=t-s;return e*e}),i=this.average(e);return Math.sqrt(i)}average(t){return t.reduce(function(t,s){return t+s},0)/t.length}addTiming(t){if(200===this.xhr.status){var s=this.xhr.responseText,e=Math.max(0,this.xhr.responseText.length-2e3);if(this.contentNeedle&&-1===(e=s.indexOf(this.contentNeedle)))return console.warn("content needle",this.contentNeedle," not found, ignoring this request"),void console.warn("response end (4k) was:",s.substr(Math.max(0,s.length-4e3)));s=s.substring(e);var i=this.timingIdx,r=this.curUrlIdx;this.ttfbs[r][i]=this.timeFirstByte,this.ttlbs[r][i]=t;var n={ttfb:this.getStats(this.ttfbs[r],i+1),ttlb:this.getStats(this.ttlbs[r],i+1)};if(this.captures)for(var a in this.captures){if(!(h=s.match(this.captures[a].regex))||h.length<2)return void console.warn("capture '"+a+"' did not match response ignoring this request",this.captures[a].regex);this.captures[a].data[r][i]=parseFloat(h[1])*this.captures[a].scale,n[a]=this.getStats(this.captures[a].data[r],i+1)}if(this.fixtures)for(var a in this.fixtures){var h=s.match(this.fixtures[a][r]);if(!h||h.length<1)return void console.warn("fixture '"+a+"' did not match response ignoring this request")}if(this.constants)for(let t in this.constants){let e=this.constants[t],i=s.match(e.r);if(!i||i.length<2)return void console.warn("constant '"+t+"' did not match response ignoring this request");if(void 0===e.v)e.v=i[1],console.info("constant '"+t+"' set to '"+e.v+"' from ",this.lastUrlString);else if(e.v!==i[1])return void console.warn("constant '"+t+"' varied, expected '"+e.v+"', got '"+i[1]+"'!",this.lastUrlString)}this.urls.length>0&&(n.urlIndex=this.curUrlIdx,n.url=this.lastUrlString),n.resp=s,this.lastProgress[r]=n;try{this.progressCallback?this.progressCallback(n):console.log(n)}catch(t){throw console.warn("exception in progress callback. stopping benchmark",t),this.cancel(),t}}else console.warn("status code != 200, ignoring this request")}}ResponseTimeBenchmark.REG_EXP={jsonNumber:function(t){return new RegExp('"'+t.replace(/\//g,"\\\\/")+'"\\s*:\\s*(-?[0-9.]+)\\s*[,}]')}};