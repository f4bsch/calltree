class HprofPlot{constructor(t,e,i){this.d3=void 0===window.d3v4?window.d3:window.d3v4;const n=this.d3,s=n.select(t);t=s.node(),this.svg=s,e=e||["Y"];const a=t.getBoundingClientRect();s.attr("width",a.width),s.attr("height",a.height);this.maxX=20,this.maxY=1,this.minY=1/0,this.zoom=1,t.plotter&&(t.removeEventListener("wheel",t.plotter.onWheel),window.removeEventListener("resize",t.plotter.onResize),t.plotter.zoom=1,t.plotter.xOverflowTransition=1,t.plotter.updateYScale(),this.fixYAxis=!0,this.maxY=t.plotter.maxY,this.minY=t.plotter.minY,s.selectAll("g.older").remove(),s.selectAll("g.old").attr("class","older").style("opacity",.2),s.selectAll("g.frame:not(.older)").attr("class","old").style("opacity",.6),s.selectAll("*.axis").remove()),t.plotter=this;const l={top:20,right:80,bottom:30,left:50},r=a.width-l.left-l.right,o=a.height-l.top-l.bottom,h=s.append("g").attr("transform","translate("+l.left+","+l.top+")").attr("class","frame"),d=this;this.onWheel=function(t){const e=Math.max(1,d.zoom-t.deltaY/100);d.zoom!==e&&t.preventDefault(),d.zoom=e,d.updateYScale()},this.onResize=function(e){d.zoom=Math.max(1,d.zoom-e.deltaY/100),s.attr("width",""),s.attr("height",""),setTimeout(function(){const e=t.getBoundingClientRect();s.attr("width",e.width),s.attr("height",e.height)},600)},t.addEventListener("wheel",this.onWheel),window.addEventListener("resize",this.onResize);const c=n.line().curve(n.curveLinear).x(function(t){return f(t.x)}).y(function(t){return p(t.y)});this.line=c;const u=i?(e.length>20?n.schemeCategory20:n.schemeCategory10).slice(0,e.length/2):e.length>10?n.schemeCategory20:n.schemeCategory10;Array.prototype.push.apply(u,u.slice());const f=n.scaleLinear().range([0,r]),p=n.scaleLinear().range([o,0]),x=n.scaleOrdinal(u);this.x=f,this.y=p,this.z=x,this.xOverflowTransition=700,this.inAxisTransitionUntil=0,f.domain([0,20]),p.domain([this.minY===1/0?0:this.minY,this.maxY]),x.domain(e);const y=[];let m=0;e.forEach(function(t){y.push({id:t,i:m++,values:[],deferredValues:[]})}),this.lines=y,h.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+o+")").call(n.axisBottom(f)),h.append("g").attr("class","axis axis--y").call(n.axisLeft(p)).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("fill","#000").text("Time, ms");const g=h.selectAll(".line").data(y).enter().append("g").style("fill","none").style("stroke-width","1.5px");g.append("path").attr("class","line").attr("d",function(t){return c(t.values)}).style("stroke",function(t){return x(t.id)}),this.area=i?n.area().x(function(t){return f(t.x)}).y0(function(t){return p((t.yU,t.y,t.yU))}).y1(function(t){return p(t.yU>t.y?t.y:t.yU)}):null,i&&h.selectAll(".area").data(y.slice(0,y.length/2)).enter().append("g").append("path").attr("class","area").style("opacity",.5).style("fill",function(t){return x(t.id)}),g.append("text").attr("class","follow").datum(function(t){return{id:t.id,i:t.i,value:t.values[t.values.length-1]||{x:0,y:0}}}).attr("transform",function(t){return"translate("+f(t.value.x)+","+p(t.value.y)+")"}).attr("x",3).attr("dy","0.35em").style("font","9px sans-serif").style("fill",function(t){return x(t.id)}).text(function(t){return t.id});const v=h.append("g").attr("class","legend");m=0,v.selectAll("text").data(y).enter().append("text").datum(function(t){return{id:m++,value:t.id}}).attr("transform",function(t){return"translate(10,"+(10+15*t.id)+")"}).attr("x",8).attr("dy","0.35em").style("fill",function(t){return x(t.value)}).text(function(t){return t.value}).style("font-weight","700").style("font-size","11px").style("font-weight","butt"),v.selectAll("text").style("paint-order","stroke").style("stroke","white").style("stroke-width","4px").style("stroke-linecap","butt").style("stroke-linejoin","miter"),this.sequence=g,this.legend=v,this.pairs=i}updateYScale(){const t=this.d3;var e=this.minY===1/0?0:this.minY;this.y.domain([e,e+(this.maxY-e)/this.zoom]);const i=this.svg.transition();this.startAxisTransition(i).select(".axis--y").duration(this.xOverflowTransition).call(t.axisLeft(this.y))}_appendDataVector(t,e,i){const n=i?"deferredValues":"values";let s;if(this.pairs){const i=e.length/2;for(s=0;s<i;s++)this.lines[s][n].push({x:t,y:e[s],yU:e[s+i]});for(;s<e.length;s++)this.lines[s][n].push({x:t,y:e[s]})}else for(s=0;s<e.length;s++)this.lines[s][n].push({x:t,y:e[s]})}addPoint(t,e,i){const n=this.d3;if(!e||!e.length||e.length!==this.lines.length)throw"py invalid";if(isNaN(t))throw"px invalid";if(e.filter(isNaN).length>0)throw"py contains NaN "+e.join(",");if(i&&(i.length!==e.length||i.filter(isNaN).length>0))throw"yMean invalid!";let s=0;this.yMean=i;const a=Math.max.apply(null,e);let l=Math.max(Math.min.apply(null,e),0);if(t>this.maxX&&(this.maxX=1.5*t,this.x.domain([0,Math.round(this.maxX)]),this.startAxisTransition().select(".axis--x").duration(this.xOverflowTransition).call(n.axisBottom(this.x))),!this.fixYAxis)if(a>this.maxY)this.maxY=1.2*a,this.updateYScale();else if(l<this.minY){if((l/=1.02)<10)l=0;else{let t=Math.pow(10,Math.floor(Math.log10(l)));l=Math.floor(l/t)*t}this.minY=l,this.updateYScale()}if(this.inAxisTransitionUntil){if(this.inAxisTransitionUntil>Date.now())return void this._appendDataVector(t,e,!0);for(this.inAxisTransitionUntil=0,s=0;s<e.length;s++)Array.prototype.push.apply(this.lines[s].values,this.lines[s].deferredValues),this.lines[s].deferredValues=[]}this._appendDataVector(t,e,!1),this.draw()}startAxisTransition(){const t=this.svg.transition().duration(this.xOverflowTransition),e=this.line,i=this;t.selectAll(".line").attr("d",function(t){return e(t.values)}).on("end",function(){i.inAxisTransitionUntil=Date.now()+10});const n=this.area;return n&&t.selectAll(".area").attr("d",function(t){return n(t.values)}),this.followText(this.xOverflowTransition),this.inAxisTransitionUntil=Math.max(this.inAxisTransitionUntil,Date.now()+1e4+10*this.xOverflowTransition),t}followText(t){const e=this.lines,i=this.yMean,n=this.x,s=this.y;let a=-1;this.sequence.selectAll("text.follow").transition().duration(t||400).attr("transform",function(){const t=e[++a].values,l=i?i[a]:t.length?t[t.length-1].y:0,r=t.length?t[t.length-1].x:0;return"translate("+(n(r)||0)+","+(s(l||0)||0)+")"})}draw(){const t=this.line,e=this.svg;e.selectAll(".line").attr("d",function(e){return t(e.values)});const i=this.area,n=this.z;if(i&&e.selectAll(".area").attr("d",function(t){return i(t.values)}).style("fill",function(t,e){return n(t.id)}),this.followText(),this.yMean){let t;const e=[];for(t=0;t<this.yMean.length;t++)e.push([this.yMean[t],t]);e.sort(function(t,e){return t[0]>e[0]?-1:1});let i=new Array(e.length);for(t=0;t<e.length;t++)i[e[t][1]]=t;this.legend.selectAll("text").transition().duration(400).attr("transform",function(t){return"translate(10,"+(10+12*i[t.id])+")"}).text(function(t){return t.value+" ("+Math.round(e[i[t.id]][0])+")"})}}appendVal(t,e){this.addPoint(this.lines[0].values.length+this.lines[0].deferredValues.length,t,e)}}